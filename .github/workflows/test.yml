name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Compute codegen input hash
        id: codegen-hash
        run: |
          HASH=$(find lib -name '*.dart' \
            ! -name '*.g.dart' ! -name '*.freezed.dart' \
            -print0 | sort -z | xargs -0 sha256sum | sha256sum | head -c 64)
          echo "key=codegen-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}-${HASH}" >> $GITHUB_OUTPUT

      - name: Restore codegen cache
        uses: actions/cache/restore@v4
        id: codegen-cache
        with:
          path: |
            .dart_tool/build
            lib/**/*.g.dart
            lib/**/*.freezed.dart
          key: ${{ steps.codegen-hash.outputs.key }}
          restore-keys: |
            codegen-${{ runner.os }}-

      - name: Create dummy .env for analysis
        run: |
          mkdir -p assets
          touch assets/.env

      - name: Run code generation
        if: steps.codegen-cache.outputs.cache-hit != 'true'
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Save codegen cache
        if: always() && steps.codegen-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            .dart_tool/build
            lib/**/*.g.dart
            lib/**/*.freezed.dart
          key: ${{ steps.codegen-hash.outputs.key }}

      - name: Cleanup old codegen caches
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_KEY="${{ steps.codegen-hash.outputs.key }}"
          gh cache list --key codegen- --limit 100 --json id,key --jq \
            ".[] | select(.key != \"$CURRENT_KEY\") | .id" \
          | while read id; do
              gh cache delete "$id" || true
            done

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze --fatal-infos

      - name: Architecture lints
        run: dart run custom_lint

      - name: Run tests
        run: flutter test

  arch-guard:
    name: Auth Architecture Guard
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check auth_provider.dart changes
        id: check-auth
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD -- \
            lib/core/providers/auth_provider.dart)
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Warn on auth_provider.dart modification
        if: steps.check-auth.outputs.changed == 'true'
        run: |
          echo "::warning file=lib/core/providers/auth_provider.dart::\
          auth_provider.dart가 변경되었습니다. \
          인증 아키텍처 규칙을 반드시 확인하세요: \
          (1) onAuthStateChange가 유일한 상태 전이 소스 \
          (2) 액션 메서드에서 state 직접 변경 금지 \
          (3) AuthErrorType.classify로 에러 처리 위임"

      - name: Add PR label
        if: steps.check-auth.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['auth-architecture']
            });
