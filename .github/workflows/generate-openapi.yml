name: Generate OpenAPI Client

on:
  workflow_dispatch:
    inputs:
      api_spec_url:
        description: 'OpenAPI Specification URL (optional, uses local file if not provided)'
        required: false
        default: ''
      create_pr:
        description: 'Create a Pull Request with generated changes'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  GENERATOR_VERSION: '6.1.0'
  OUTPUT_DIR: 'lib/shared/api/generated'

jobs:
  generate-openapi:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Set up Java (required by OpenAPI Generator)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ’™ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: ðŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ðŸŒ Download OpenAPI Spec (if URL provided)
        if: github.event.inputs.api_spec_url != ''
        run: |
          curl -o lib/openapi/openapi.json "${{ github.event.inputs.api_spec_url }}"
          echo "âœ“ OpenAPI spec downloaded from provided URL"

      - name: âœ… Verify OpenAPI Spec exists
        run: |
          if [ ! -f "lib/openapi/openapi.json" ]; then
            echo "âŒ Error: lib/openapi/openapi.json not found"
            exit 1
          fi
          echo "âœ“ OpenAPI spec found"

      - name: ðŸš€ Install OpenAPI Generator CLI
        run: dart pub global activate openapi_generator_cli ${{ env.GENERATOR_VERSION }}

      - name: ðŸ”¨ Generate OpenAPI Client
        run: |
          openapi-generator generate \
            -i lib/openapi/openapi.json \
            -g dart-dio \
            -o ${{ env.OUTPUT_DIR }} \
            --additional-properties="useFreezed=true,useNullSafety=true,enumUnknownDefaultCase=true,pubName=openapi_client" \
            --skip-validate-spec

      - name: ðŸ“š Get Flutter dependencies (post-generation)
        run: flutter pub get

      - name: âœ¨ Format generated code
        run: |
          dart format ${{ env.OUTPUT_DIR }}/lib/src --line-length 120
        continue-on-error: true

      - name: ðŸ§ª Run analyzer on generated code
        run: |
          dart analyze ${{ env.OUTPUT_DIR }}/lib/openapi_client.dart \
            ${{ env.OUTPUT_DIR }}/lib/src/api.dart
        continue-on-error: true

      - name: ðŸ“ Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected"
            echo "---"
            git diff --stat
          fi

      - name: ðŸ“‹ Display generated file summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "## ðŸ“Š Generated Files Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Classes" >> $GITHUB_STEP_SUMMARY
          find ${{ env.OUTPUT_DIR }}/lib/src/api -name "*.dart" -type f | wc -l | xargs echo "- Total:" >> $GITHUB_STEP_SUMMARY
          find ${{ env.OUTPUT_DIR }}/lib/src/api -name "*.dart" -type f | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Model Classes" >> $GITHUB_STEP_SUMMARY
          find ${{ env.OUTPUT_DIR }}/lib/src/model -name "*.dart" -type f | wc -l | xargs echo "- Total:" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”„ Create Pull Request
        if: >
          steps.check_changes.outputs.changes == 'true' &&
          github.event.inputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: regenerate OpenAPI client

            - Regenerated OpenAPI client from lib/openapi/openapi.json
            - Generator: openapi_generator_cli v${{ env.GENERATOR_VERSION }}
            - Generator type: dart-dio
            - Triggered by: ${{ github.actor }}

            ${{ github.event.head_commit.message }}
          branch: openapi/update-client-${{ github.run_number }}
          delete-branch: true
          title: 'chore: regenerate OpenAPI client'
          body: |
            ## ðŸ¤– Automated OpenAPI Client Generation

            This PR updates the OpenAPI client based on the latest API specification.

            ### Changes
            - Regenerated OpenAPI client from `lib/openapi/openapi.json`
            - Generator: `openapi_generator_cli` v${{ env.GENERATOR_VERSION }}
            - Type: dart-dio

            ### What to check
            - [ ] Generated API methods are correct
            - [ ] Model classes match the API spec
            - [ ] No breaking changes in the client interface

            ---
            Generated at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Triggered by: @${{ github.actor }}
          labels: |
            ðŸ¤– generated
            ðŸ“¦ api
          draft: false
          assignees: ${{ github.actor }}

      - name: âš ï¸ No changes detected
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "## â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The OpenAPI client is already up-to-date with the specification." >> $GITHUB_STEP_SUMMARY

      - name: âœ… Generation completed
        run: |
          echo "## âœ… OpenAPI Client Generation Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Output directory: \`${{ env.OUTPUT_DIR }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Generator version: ${{ env.GENERATOR_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes detected: ${{ steps.check_changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR created: ${{ github.event.inputs.create_pr }}" >> $GITHUB_STEP_SUMMARY
