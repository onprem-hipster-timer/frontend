name: Auto-Generate OpenAPI on Spec Update

on:
  push:
    paths:
      - 'lib/openapi/openapi.json'
    branches:
      - develop
      - main
  pull_request:
    paths:
      - 'lib/openapi/openapi.json'
    branches:
      - develop
      - main

env:
  GENERATOR_VERSION: '6.1.0'
  OUTPUT_DIR: 'lib/shared/api/generated'

jobs:
  check-and-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ’™ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: ðŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ðŸš€ Install OpenAPI Generator CLI
        run: dart pub global activate openapi_generator_cli ${{ env.GENERATOR_VERSION }}

      - name: ðŸ”¨ Generate OpenAPI Client
        run: |
          openapi-generator generate \
            -i lib/openapi/openapi.json \
            -g dart-dio \
            -o ${{ env.OUTPUT_DIR }} \
            --additional-properties="useFreezed=true,useNullSafety=true,enumUnknownDefaultCase=true,pubName=openapi_client" \
            --skip-validate-spec

      - name: ðŸ“š Get Flutter dependencies (post-generation)
        run: flutter pub get

      - name: âœ¨ Format generated code
        run: |
          dart format ${{ env.OUTPUT_DIR }}/lib/src --line-length 120
        continue-on-error: true

      - name: ðŸ“ Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Commit generated code
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ${{ env.OUTPUT_DIR }}
          git commit -m "chore: regenerate OpenAPI client

          - Auto-generated from updated lib/openapi/openapi.json
          - Generator: openapi_generator_cli v${{ env.GENERATOR_VERSION }}
          - Triggered by: push to ${{ github.ref_name }}"
          git push

      - name: ðŸ’¬ Comment on PR
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **OpenAPI Spec Updated**\n\nThe `lib/openapi/openapi.json` file has been modified. The OpenAPI client code has been regenerated and needs to be committed.\n\nðŸ“‹ **Action Required:**\n1. Review the generated changes in `lib/shared/api/generated/`\n2. Run `flutter pub get` to update dependencies\n3. Push the updated code\n\n**Generated by:** openapi_generator_cli v${{ env.GENERATOR_VERSION }}'
            })

      - name: âš ï¸ Request review
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.requestReviewers({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              reviewers: ['${{ github.actor }}']
            })

      - name: âœ… Summary
        run: |
          echo "## ðŸ¤– OpenAPI Client Auto-Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes detected: ${{ steps.check_changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
            echo "- Action: Code regenerated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Action: No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
